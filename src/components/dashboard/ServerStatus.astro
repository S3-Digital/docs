---
const { enabled, apiKey } = Astro.props;
---

{enabled && (
  <div class="status-card" style="margin-bottom: 2rem; padding: 1rem; background: var(--sl-color-bg-nav); border: 1px solid var(--sl-color-hairline); border-radius: 0.75rem; box-shadow: var(--sl-shadow-sm);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div id="status-dot" class="dot-loading"></div>
        <span style="font-weight: 600; font-size: 0.95rem; color: var(--sl-color-white);">Status systemów Sikora Digital</span>
      </div>
      <span id="status-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--sl-color-gray-3);">Sprawdzanie...</span>
    </div>
    <div id="uptime-container" style="margin-top: 12px; height: 6px; background: var(--sl-color-gray-6); border-radius: 3px; overflow: hidden; display: none;">
        <div id="uptime-fill" style="width: 0%; height: 100%; background: #10b981; transition: width 1.5s ease-out;"></div>
    </div>
  </div>
)}

<style>
  .dot-loading {
    width: 10px; height: 10px; border-radius: 50%; background: var(--sl-color-gray-4);
  }
  .dot-online {
    width: 10px; height: 10px; border-radius: 50%; background: #10b981;
    box-shadow: 0 0 8px #10b981;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
</style>

<script define:vars={{ apiKey }}>
  async function fetchStatus() {
    const dot = document.getElementById('status-dot');
    const label = document.getElementById('status-label');
    const container = document.getElementById('uptime-container');
    const fill = document.getElementById('uptime-fill');

    try {
      const res = await fetch('https://api.uptimerobot.com/v2/getMonitors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `api_key=${apiKey}&format=json`
      });
      const data = await res.json();

      if (data.stat === 'ok' && data.monitors[0].status === 2) {
        dot.className = 'dot-online';
        label.innerText = 'Wszystkie systemy działają prawidłowo';
        label.style.color = '#10b981';
        container.style.display = 'block';
        setTimeout(() => { fill.style.width = '100%'; }, 100);
      } else {
        label.innerText = 'Wykryto utrudnienia';
        dot.style.background = '#ef4444';
      }
    } catch (e) {
      label.innerText = 'Błąd połączenia ze statusem';
    }
  }
  if (apiKey) fetchStatus();
</script>