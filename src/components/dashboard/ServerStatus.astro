---
// src/components/dashboard/ServerStatus.astro
interface Props {
  enabled: boolean;
  apiKey: string;
}

const { enabled, apiKey } = Astro.props;

// UWAGA: Usunąłem sprawdzanie if (!enabled), żeby wymusić wyświetlenie
---

<div style="border: 4px solid red; background: #ffe6e6; color: red; padding: 1rem; margin-bottom: 1rem; font-weight: bold;">
  <p>--- TRYB DIAGNOSTYCZNY ---</p>
  <p>Czy moduł włączony? (Enabled): <code>{JSON.stringify(enabled)}</code></p>
  <p>Czy jest klucz API? (API Key): <code>{apiKey ? apiKey : "BRAK KLUCZA"}</code></p>
</div>

<div class="server-widget">
  <div class="header">
    <strong>Status Usługi</strong>
    <span id="status-badge" class="badge loading">Ładowanie...</span>
  </div>

  <div class="progress-bg">
    <div id="uptime-bar" class="progress-fill"></div>
  </div>
  
  <p class="meta">
    Dostępność (24h): <span id="uptime-text">--%</span>
  </p>
</div>

<style>
  .server-widget {
    padding: 1rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    background: var(--sl-color-bg-nav);
    margin: 1.5rem 0;
    box-shadow: var(--sl-shadow-sm);
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  .badge {
    padding: 0.2rem 0.6rem;
    border-radius: 99px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
  }
  .badge.loading { background: var(--sl-color-gray-4); color: var(--sl-color-gray-1); }
  .badge.online { background: #dcfce7; color: #166534; }
  .badge.offline { background: #fee2e2; color: #991b1b; }

  .progress-bg {
    width: 100%;
    height: 0.6rem;
    background: var(--sl-color-gray-5);
    border-radius: 99px;
    overflow: hidden;
  }
  .progress-fill {
    width: 0%;
    height: 100%;
    background: #22c55e;
    transition: width 1s ease-in-out;
  }
  .meta {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--sl-color-gray-3);
    text-align: right;
  }
</style>

<script define:vars={{ apiKey }}>
  async function checkServer() {
    try {
      if (!apiKey) return; // Nie wykonuj zapytania bez klucza
      
      const response = await fetch('https://api.uptimerobot.com/v2/getMonitors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `api_key=${apiKey}&format=json`
      });

      const data = await response.json();
      
      if (data.stat === 'ok' && data.monitors && data.monitors.length > 0) {
        const monitor = data.monitors[0];
        const isUp = monitor.status === 2;
        
        const badge = document.getElementById('status-badge');
        const bar = document.getElementById('uptime-bar');
        const text = document.getElementById('uptime-text');

        if (badge && bar && text) {
            badge.innerText = isUp ? 'ONLINE' : 'OFFLINE';
            badge.className = isUp ? 'badge online' : 'badge offline';

            let uptimeVal = 100;
            if (monitor.custom_uptime_ratio) {
                uptimeVal = parseFloat(monitor.custom_uptime_ratio.split('-')[0]);
            }
            
            bar.style.width = `${uptimeVal}%`;
            text.innerText = `${uptimeVal}%`;
            
            if(uptimeVal < 90) bar.style.background = '#ef4444';
        }
      }
    } catch (e) {
      console.error("Widget Error:", e);
      const badge = document.getElementById('status-badge');
      if(badge) badge.innerText = "Błąd API";
    }
  }

  checkServer();
</script>